<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta title="eSDE-notes">

    <link rel="alternate" type="application/atom+xml" title="Notes collected during development, work, learning..." href="/atom.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Mateusz Myalski">
    <meta name="google-site-verification" content="A8chtL3v4vPM3jRZZVlCtwpChyjii_n7C9bifQOfYzg" />
    <link rel="shortcut icon" href="https://mateuszmyalski.github.io/theme/favicon.png" type="image/x-icon">
    <link rel="icon" href="https://mateuszmyalski.github.io/theme/favicon.png" type="image/x-icon">

    <meta name="description" content="Notes collected during development, work, learning..." />

    <link rel="stylesheet" type="text/css" href="https://mateuszmyalski.github.io/theme/css/style.css" />

</head>

<body>
    <header>
        <hgroup>
            <h1>
                <a href="https://mateuszmyalski.github.io/index.html">eSDE-notes</a>
            </h1>
            <p>Notes collected during development, work, learning...</p>
        </hgroup>

        <nav>
            <li>
                <a href="https://mateuszmyalski.github.io/pages/compendium.html">Compendium</a>
            </li>
            <li>
                <a href="https://github.com/MateuszMyalski">GitHub</a>
            </li>
            <li>
                <a href="atom.xml">RSS</a>
            </li>
        </nav>

    </header>

    <main>

<section class="post">
    <h1>STM development on linux</h1>
<h2>Introduction</h2>
<p>Setting up a development environment can be time-consuming especially, when working with new platforms. During my hobby projects, I always struggled to find easy to follow how-to prepare full standalone environment for STM32. I am not big fan to work with all the regenerated project structures like PlatformIO, CubeMX or Arduino. When I am working on my hobby projects, I would like to go over difficulties that can teach me something new.</p>
<p>This small article presents how to create a simple standalone working environment for STM32 development.</p>
<h2>Installing the compiler</h2>
<p>Arm-none-eabi compiler: <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads">Downloads | GNU Arm Embedded Toolchain Downloads – Arm Developer</a>    </p>
<p>To make this compiler available everywhere, add the <code>gcc-arm-none-eabi/bin</code> directory to the <code>PATH</code> env. variable. To use it in Makefiles only use <code>gcc-arm-none-eabi/bin</code> path in variable.</p>
<h2>Installing the programmer</h2>
<ol>
<li>Download Linux files of <a href="https://www.st.com/en/development-tools/stm32cubeprog.html">STM32CubeProg - STMicroelectronics</a>.</li>
<li>Install STM32CubeProgrammer.</li>
<li>Execute install STM32CubeProgrammer file.</li>
<li>After unpacking the STM32CubeProgrammer, add <code>Cube Programmer</code>  libraries to your .bashrc file. <code>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/STMicroelectronics/STM32Cube/STM32CubeProgrammer/lib/</code></li>
<li>Give permission to libUSB by: <code>cd &lt;INSTALATION_PATH&gt;/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/
sudo cp .* /etc/udev/rules.d</code></li>
</ol>
<h2>Installing the stlink-gdb</h2>
<p>It is possible to use OpenOCD to connect to the target board. However, the problem is that not always the newest platforms are already in the config files. The stlink-gdb server is always ready to work with your platform and most of the GDB configs are done for the developers. This usually the most frustrating thing when starting the debugger – configuring it.</p>
<p>Unfortunately, the ST does not give easy way of downloading JUST the stling-gdb server. Instead, it is needed to download the CubeIDE and take the binary from it.</p>
<ol>
<li>Download CubeIDE <a href="https://www.st.com/en/development-tools/stm32cubeide.html">STM32CubeIDE - STMicroelectronics</a>  </li>
<li>Unzip the file.</li>
<li>Extract Makefiles and go to plugins.</li>
</ol>
<div class="highlight"><pre><span></span><code>unzip<span class="w"> </span>en.st-stm32cubeide*
bash<span class="w"> </span>st-stm32cubeide*<span class="w"> </span>--noexec<span class="w"> </span>
<span class="nb">cd</span><span class="w"> </span>st-stm32cubeide*.root<span class="w"> </span>
tar<span class="w"> </span>xvzf<span class="w"> </span>st-stm32cubeide*.tar.gz<span class="w"> </span>
<span class="nb">cd</span><span class="w"> </span>plugins
</code></pre></div>

<ol>
<li>Find folder named <code>com.st.stm32cube.ide.mcu.externaltools.stlink-gdb-server.*</code></li>
<li>Copy its tools folder to the <code>&lt;INSTALATION_PATH&gt;/STMicroelectronics/STLink-GDB-Server</code>  </li>
<li>Create config file in <code>&lt;INSTALATION_PATH&gt;/STMicroelectronics/STLink-GDB-Server/bin/config.txt</code></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">#-e: Enables persistant mode</span>
-e

<span class="c1">#-f &lt;Log-File&gt;: Name of log file. Please make sure</span>
<span class="c1">#               that directory not is write protected.</span>
-f<span class="w"> </span>debug.log

<span class="c1">#-p &lt;Port-Number&gt;: TCP-Listen Port-Number.</span>
-p<span class="w"> </span><span class="m">3333</span>

<span class="c1">#-r &lt;delay-sec&gt;: Maximum Delay in status refresh</span>
-r<span class="w"> </span><span class="m">15</span>

<span class="c1">#-d: Enables SWD mode</span>
-d

<span class="c1">#-t: Shared mode using ST-LINK server</span>
-t

<span class="c1">#-cp &lt;path&gt;: Path to STM32CubeProgrammer</span>
<span class="c1">#          Modify to correct path</span>
<span class="c1">#          for STM32_Programmer_CLI executable</span>
-cp<span class="w"> </span>../../STM32Cube/STM32CubeProgrammer/bin/
</code></pre></div>

<ol>
<li>Create script <code>stlink-gdb-server.sh</code>
    <code>bash
    #!/bin/bash 
    cd &lt;INSTALLATION_PATH&gt;/STMicroelectronics/STLink-GDB-Server/bin 
    bash ST-LINK_gdbserver.sh</code></li>
<li>Add <code>chmod</code> on the <code>stlink-gdb-server.sh</code> and copy in into the <code>/usr/bin</code> directory
    <code>bash
    chmod +x stlink-gdb-server.sh
    mv stlink-gdb-server.sh /usr/bin</code></li>
</ol>
<h3>Installing other useful tools</h3>
<h2>Minicom - serial terminal</h2>
<p>Simple CLI based serial terminal. Easy to navigate and to use.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>minicom
</code></pre></div>

<h2>Saleae - logic analyzer software</h2>
<p>I like to use Saleae logic analyzer. They are also supplying pretty nice software to interact with their devices. Not only the original devices uses them also this <a href="https://www.az-delivery.de/products/saleae-logic-analyzer">Chainees Logic Analyzer</a>. </p>
<p>To download SW: <a href="https://www.saleae.com/downloads/">Logic analyzer software from Saleae</a></p>
<h2>ST-LINK server</h2>
<ol>
<li>Download the <a href="https://www.st.com/en/development-tools/st-link-server.html">ST-LINK-SERVER - STMicroelectronics</a></li>
<li>Unpack the folder  .</li>
<li>Execute:</li>
</ol>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>st-stlink-server-xxxx-linux-amd64.deb
</code></pre></div>

<ol>
<li>To run - execute <code>stlink-server</code>.</li>
</ol>
<h1>How to use tools</h1>
<h2>Running the GDB</h2>
<ol>
<li>Connect ST-Link.</li>
<li>Execute <code>stlink-gdb-server</code>.</li>
<li>Execute the GDB <code>arm-none-eabi-gdb</code>.</li>
<li>In GDB run</li>
</ol>
<div class="highlight"><pre><span></span><code>target<span class="w"> </span>extended-remote<span class="w"> </span>localhost:3333
file<span class="w"> </span>&lt;PATH_TO_ELF&gt;
b<span class="w"> </span>main
<span class="k">continue</span>
</code></pre></div>

<h2>Programming from CLI</h2>
<p>The <code>CubeProgrammer</code> must be installed, then execute:</p>
<div class="highlight"><pre><span></span><code>&lt;CUBE_PROGRAMMER_BIN_PATH&gt;/STM32_Programmer.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="nv">port</span><span class="o">=</span>SWD<span class="w"> </span><span class="nv">freq</span><span class="o">=</span><span class="m">4000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-w<span class="w"> </span>&lt;OUT_PATH&gt;/&lt;APP_NAME&gt;.hex<span class="w"> </span>0x08000000<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-s
</code></pre></div>

<h1>VSCode</h1>
<h2>GDB interaction</h2>
<p>Create <code>launch.json</code> with content:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;configurations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;(gdb) Launch&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cppdbg&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;request&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;launch&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;program&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;PATH_TO_APP&gt;.elf&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;miDebuggerPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;TOOLCHAIN_PATH&gt;/gcc-arm-none-eabi/bin/arm-none-eabi-gdb&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;miDebuggerServerAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;localhost:3333&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;MIMode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gdb&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cwd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;setupCommands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Enable pretty-printing for gdb&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;-enable-pretty-printing&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;ignoreFailures&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>To run the debbuging session, first execute in the terminal <code>stlink-gdb-server.sh</code>, and launch debugging from the VSCode.</p>
<h2>Project rebuild</h2>
<p>Tasks in VSCode can be really helpful, the most basic ones are to run <code>make</code> commands by pressing <code>CTRL+B</code> or selecting it with <code>CTRL+SHIFT+B</code>.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tasks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Build project&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;make all&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Clean project&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;make clean&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Info project&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;build&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;make info&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h2>Auto-flashing</h2>
<p>Being able to flash the .hex file into the target via simple click is way easier than going through GUI interface. It is possible to automate the procedure with simple task.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tasks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Upload binary&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;PATH_TO_PROGRAMMER&gt;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;problemMatcher&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>Path to programmer:</p>
<div class="highlight"><pre><span></span><code>&lt;INSTALL_PATH&gt;/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin/STM32_Programmer.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-c<span class="w"> </span><span class="nv">port</span><span class="o">=</span>SWD<span class="w"> </span><span class="nv">freq</span><span class="o">=</span><span class="m">4000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-w<span class="w"> </span>&lt;PATH_TO_APP&gt;.hex<span class="w"> </span>0x08000000<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-s
</code></pre></div>

<h1>Troubleshooting</h1>
<h2>GDB needs ncurses</h2>
<p>Missing <code>ncurses</code> when running GDB?
Run:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>libncurses5<span class="w"> </span>libncurses5:i386
</code></pre></div>

<h2>References</h2>
<ul>
<li><a href="http://pacinispace.blogspot.com/2020/02/stm32cubeide-st-link-gdb-server-on-linux.html">STM32CubeIDE programmer and ST-LINK GDB server on Linux</a></li>
</ul>

    <section class="meta">
        <div class="title_block">
            <span class="title_label">
                Title:
            </span>
            <span class="title">
                STM development on linux
            </span>
        </div>
        <div class="date_block">
            <span class="date_label">
                Posted on:
            </span>
            <span class="date">
                <time datetime="2022-07-03T00:00:00+02:00">03/07/2022
            </span>
        </div>
        <div class="print">
            <a href="javascript:if(window.print)window.print()">🖨️ Print</a>
        </div>
    </section>
</section>

</section>

    </main>

    <footer>
        Made with<span id="heart">&#9829;</span>
    </footer>
</body>

</html>